name: Release Daemon Tool

on:
  push:
    tags: ['daemon-v*']

permissions: {}

jobs:
  extract-version:
    name: Extract Version
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      version: ${{ steps.version.outputs.version }}
      dmg_name: ${{ steps.version.outputs.dmg_name }}
      tar_name: ${{ steps.version.outputs.tar_name }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/daemon-v}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "::error::Invalid semver format: $VERSION (expected X.Y or X.Y.Z)"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "dmg_name=claude-kvm-daemon-${VERSION}-darwin-arm64.dmg" >> "$GITHUB_OUTPUT"
          echo "tar_name=claude-kvm-daemon-${VERSION}-darwin-arm64.tar.gz" >> "$GITHUB_OUTPUT"

  build:
    needs: extract-version
    uses: ./.github/workflows/build-daemon.yml
    with:
      version: ${{ needs.extract-version.outputs.version }}
    secrets:
      DEVELOPER_ID_CERTIFICATE_P12: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
      DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

  create-release:
    name: Create GitHub Release
    needs: [extract-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: success()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: ${{ runner.temp }}/release
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          tag_name: "daemon-v${{ needs.extract-version.outputs.version }}"
          name: "claude-kvm-daemon ${{ needs.extract-version.outputs.version }}"
          body: ""
          files: |
            ${{ runner.temp }}/release/${{ needs.extract-version.outputs.dmg_name }}
            ${{ runner.temp }}/release/${{ needs.extract-version.outputs.tar_name }}
          draft: false
          prerelease: false
          generate_release_notes: false
