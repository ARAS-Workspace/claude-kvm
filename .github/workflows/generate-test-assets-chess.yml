# SPDX-License-Identifier: MIT
# Claude KVM — Test Asset Generator (Mac Chess)
#
# Extracts logs + screen recording from a Mac Chess CI test run,
# generates asciinema cast, terminal MP4, screen MP4 (4x speed),
# and a composite split-screen MP4.
#
# Manual trigger — scripts live on press-kit branch.

name: Generate Test Assets (Mac Chess)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      TZ: Europe/Istanbul
      RUN_ID: '22286704229'
      ARTIFACT_NAME: 'test-artifacts-chess-direct'
      SPEED: '4'

    steps:
      - name: Checkout press-kit branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: press-kit
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '22'

      # ── Extract Logs ────────────────────────────────────

      - name: Download test artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download "$RUN_ID" \
            -n "$ARTIFACT_NAME" -D ./artifacts
          ls -lh artifacts/

      - name: Extract logs and compute sync
        id: sync
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "repos/${{ github.repository }}/actions/runs/${RUN_ID}/logs" > logs.zip
          unzip -o logs.zip -d logs/
          node scripts/parse-ci-logs.js logs/ >> $GITHUB_OUTPUT

      # ── Generate Cast + Terminal MP4 ────────────────────

      - name: Generate asciinema cast
        run: |
          cat test-logs.txt | node scripts/logs-to-cast.js "$SPEED" > test.cast
          echo "Cast lines: $(wc -l < test.cast)"

      - name: Build agg image
        run: |
          git clone --depth 1 https://github.com/asciinema/agg /tmp/agg
          docker build -t agg /tmp/agg

      - name: Render terminal GIF (intermediate)
        run: |
          docker run --rm -v "$PWD:/data" agg \
            --font-size 14 --theme solarized-dark \
            /data/test.cast /data/test-terminal.gif
          ls -lh test-terminal.gif

      # ── Generate Videos ─────────────────────────────────

      - name: Install ffmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg

      - name: Build terminal MP4
        run: |
          ffmpeg -y -i test-terminal.gif \
            -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" \
            -c:v libx264 -crf 18 -preset slow \
            -pix_fmt yuv420p -r 30 \
            -movflags +faststart \
            test-terminal.mp4
          ls -lh test-terminal.mp4

      - name: Build screen MP4 (trimmed + speed)
        run: |
          OFFSET=${{ steps.sync.outputs.OFFSET }}
          DURATION=${{ steps.sync.outputs.DURATION }}
          PTS=$(echo "scale=4; 1/${SPEED}" | bc)

          echo "Offset: ${OFFSET}s  Duration: ${DURATION}s  PTS: ${PTS}"

          ffmpeg -y -ss "$OFFSET" -t "$DURATION" -i artifacts/recording.mp4 \
            -filter:v "setpts=${PTS}*PTS" \
            -an -c:v libx264 -crf 18 -preset slow \
            -pix_fmt yuv420p \
            test-screen.mp4
          ls -lh test-screen.mp4

      - name: Build composite (split-screen)
        run: |
          NAME="test-mac-chess-run-${RUN_ID}"

          ffmpeg -y -i test-screen.mp4 -i test-terminal.mp4 \
            -filter_complex "
              [0:v]scale=-2:720[left];
              [1:v]scale=-2:720[right];
              [left][right]hstack=inputs=2
            " \
            -c:v libx264 -crf 18 -preset slow \
            -pix_fmt yuv420p -movflags +faststart \
            -shortest \
            "${NAME}.mp4"

          echo "=== Output files ==="
          ls -lh "${NAME}.mp4" test-*.mp4 test.cast

      # ── Upload ──────────────────────────────────────────

      - name: Upload test assets
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-assets-mac-chess-${{ env.RUN_ID }}
          path: |
            test.cast
            test-terminal.mp4
            test-screen.mp4
            test-mac-chess-run-${{ env.RUN_ID }}.mp4

      # ── Push to press-kit ──────────────────────────────────

      - name: Push assets to press-kit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NAME="test-mac-chess-run-${RUN_ID}"

          mkdir -p assets/test/mac/chess
          cp test.cast test-terminal.mp4 \
             test-screen.mp4 "${NAME}.mp4" \
             assets/test/mac/chess/

          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -f assets/test/mac/chess/
          git commit -m "Add test assets from run ${NAME}"
          git push origin press-kit