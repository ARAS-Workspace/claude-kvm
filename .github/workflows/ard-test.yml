# Quick test: Create VNC user, enable ARD, connect via daemon

name: ARD Connection Test

on:
  workflow_dispatch:

jobs:
  ard-test:
    runs-on: macos-26
    timeout-minutes: 10

    steps:
      - name: Create VNC user
        run: |
          sudo dscl . -create /Users/vncuser
          sudo dscl . -create /Users/vncuser UserShell /bin/bash
          sudo dscl . -create /Users/vncuser RealName "VNC User"
          sudo dscl . -create /Users/vncuser UniqueID "1099"
          sudo dscl . -create /Users/vncuser PrimaryGroupID 20
          sudo dscl . -create /Users/vncuser NFSHomeDirectory /Users/vncuser
          sudo dscl . -passwd /Users/vncuser testpass
          sudo dscl . -append /Groups/admin GroupMembership vncuser
          sudo createhomedir -c -u vncuser

      - name: Enable ARD for vncuser
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -restart -agent \
            -allowAccessFor -specifiedUsers -users vncuser
          sleep 3
          nc -z localhost 5900 && echo "VNC port open" || { echo "VNC port closed"; exit 1; }

      - name: Install daemon
        run: brew install ARAS-Workspace/tap/claude-kvm-daemon

      - name: Test daemon connection
        run: |
          ( sleep 5; echo '{"method":"health","id":1}'; sleep 5 ) | claude-kvm-daemon \
            --host 127.0.0.1 --port 5900 --username vncuser --password testpass \
            > /tmp/daemon-stdout.log 2> /tmp/daemon-stderr.log || true
          echo "=== STDOUT ==="
          cat /tmp/daemon-stdout.log
          echo "=== STDERR ==="
          cat /tmp/daemon-stderr.log
          grep -q '"result"' /tmp/daemon-stdout.log && echo "PASSED" || { echo "FAILED"; exit 1; }
