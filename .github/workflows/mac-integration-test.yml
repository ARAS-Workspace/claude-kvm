# SPDX-License-Identifier: MIT
# Claude KVM — Mac Integration Test (Scaleway Apple Silicon)
#
# Pre-provisioned Scaleway Mac mini M1 with native macOS + ARD/VNC.
# Direct connection — no SSH tunnel.

name: Mac Integration Test

on:
  push:
    tags:
      - 'mac-test-v*'

env:
  TZ: Europe/Istanbul
  EXECUTOR_MODEL: claude-opus-4-6
  OBSERVER_MODEL: qwen/qwen3-vl-235b-a22b-instruct
  EXECUTOR_MAX_TURNS: '30'

# ─────────────────────────────────────────────────────────────

jobs:
  integration-test:
    runs-on: macos-26
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── SSH Setup ──────────────────────────────────────────

      - name: Setup SSH
        env:
          MAC_SSH_PRIVATE_KEY: ${{ secrets.MAC_SSH_PRIVATE_KEY }}
          MAC_HOST: ${{ secrets.MAC_HOST }}
          MAC_VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
        run: |
          echo "::add-mask::$MAC_HOST"

          mkdir -p ~/.ssh
          printf '%s\n' "$MAC_SSH_PRIVATE_KEY" > /tmp/mac_key
          chmod 600 /tmp/mac_key

          # Set up control socket for screen recording steps
          ssh -fN \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o LogLevel=ERROR \
            -o ControlPath=/tmp/mac_ssh \
            -o ControlMaster=yes \
            -o ControlPersist=yes \
            -i /tmp/mac_key \
            "${MAC_VNC_USERNAME}@${MAC_HOST}"

          echo "SSH ready"

      # ── Screen Recording ───────────────────────────────────

      - name: Start screen recording
        run: |
          MAC_SSH="ssh -S /tmp/mac_ssh placeholder"

          # ffmpeg avfoundation — requires Screen Recording permission for Terminal
          $MAC_SSH "nohup ffmpeg -f avfoundation -capture_cursor 1 -framerate 10 \
            -i '1:none' -c:v libx264 -preset ultrafast -pix_fmt yuv420p \
            /tmp/recording.mp4 > /tmp/ffmpeg.log 2>&1 & echo \$! > /tmp/ffmpeg.pid" \
            2>/dev/null

          sleep 2
          $MAC_SSH "kill -0 \$(cat /tmp/ffmpeg.pid 2>/dev/null) 2>/dev/null" \
            && echo "Screen recording started" \
            || echo "Screen recording failed (non-fatal)"

      # ── Test Execution ─────────────────────────────────────

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Install daemon
        run: brew install ARAS-Workspace/tap/claude-kvm-daemon

      - name: Run integration test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: ${{ secrets.MAC_HOST }}
          VNC_PORT: ${{ secrets.MAC_VNC_PORT }}
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          SCREENSHOTS_DIR: ./test-screenshots
        run: |
          echo "::add-mask::$VNC_HOST"
          mkdir -p test-screenshots
          node test/integration.js

      # ── Cleanup (always) ───────────────────────────────────

      - name: Stop recording and download
        if: always()
        run: |
          MAC_SSH="ssh -S /tmp/mac_ssh placeholder"

          $MAC_SSH 'kill -INT $(cat /tmp/ffmpeg.pid 2>/dev/null) 2>/dev/null; sleep 3' || true

          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/recording.mp4 2>/dev/null || \
          echo "No recording file"

      - name: Close SSH
        if: always()
        run: |
          ssh -S /tmp/mac_ssh -O exit placeholder 2>/dev/null || true
          rm -f /tmp/mac_key

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-mac
          path: test-screenshots/
          if-no-files-found: ignore
