# SPDX-License-Identifier: MIT
# Claude KVM — Mac Integration Flow (Scaleway Apple Silicon)
#
# Orchestration workflow — runs all Mac tests sequentially with
# a clean reboot between each test.

name: Mac Integration Flow

on:
  push:
    tags:
      - 'mac-test-flow-v*'

env:
  TZ: Europe/Istanbul
  EXECUTOR_MODEL: claude-opus-4-6
  OBSERVER_MODEL: qwen/qwen3-vl-235b-a22b-instruct
  EXECUTOR_MAX_TURNS: '30'

# ─────────────────────────────────────────────────────────────

jobs:
  integration-flow:
    runs-on: macos-26
    timeout-minutes: 120

    env:
      MAC_HOST: ${{ secrets.MAC_HOST }}
      MAC_VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mask secrets
        run: echo "::add-mask::$MAC_HOST"

      # ── One-time Setup ────────────────────────────────────

      - name: Setup SSH key
        env:
          MAC_SSH_PRIVATE_KEY: ${{ secrets.MAC_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$MAC_SSH_PRIVATE_KEY" > /tmp/mac_key
          chmod 600 /tmp/mac_key

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Install daemon
        run: brew install ARAS-Workspace/tap/claude-kvm-daemon

      - name: Create output directories
        run: |
          mkdir -p test-screenshots/integration
          mkdir -p test-screenshots/calculator
          mkdir -p test-screenshots/scientific
          mkdir -p test-screenshots/safari

      # ════════════════════════════════════════════════════════
      # TEST 1 — Integration (Finder)
      # ════════════════════════════════════════════════════════

      - name: '[1/4] SSH connect'
        run: |
          ssh -fN \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o LogLevel=ERROR -o ControlPath=/tmp/mac_ssh \
            -o ControlMaster=yes -o ControlPersist=yes \
            -i /tmp/mac_key "${MAC_VNC_USERNAME}@${MAC_HOST}"

      - name: '[1/4] Cleanup + start recording'
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: '[1/4] Run integration test'
        id: test_integration
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: ${{ secrets.MAC_HOST }}
          VNC_PORT: ${{ secrets.MAC_VNC_PORT }}
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          SCREENSHOTS_DIR: ./test-screenshots/integration
        run: |
          echo "::add-mask::$VNC_HOST"
          node test/integration.js

      - name: '[1/4] Stop recording + cleanup'
        if: always()
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/integration/recording.mp4 2>/dev/null || true
          ssh -S /tmp/mac_ssh placeholder "
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
            osascript -e 'tell app \"System Events\" to key code 36' 2>/dev/null
          " || true

      - name: '[1/4] Reboot + wait'
        if: always()
        run: |
          ssh -S /tmp/mac_ssh -O exit placeholder 2>/dev/null || true
          ssh -i /tmp/mac_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "${MAC_VNC_USERNAME}@${MAC_HOST}" "sudo reboot" || true
          echo "Waiting for Mac to come back..."
          for i in $(seq 1 60); do
            ssh -i /tmp/mac_key -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null "${MAC_VNC_USERNAME}@${MAC_HOST}" \
              "echo ready" 2>/dev/null && break
            sleep 5
          done
          echo "Mac is ready"

      # ════════════════════════════════════════════════════════
      # TEST 2 — Calculator
      # ════════════════════════════════════════════════════════

      - name: '[2/4] SSH connect'
        if: always()
        run: |
          ssh -fN \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o LogLevel=ERROR -o ControlPath=/tmp/mac_ssh \
            -o ControlMaster=yes -o ControlPersist=yes \
            -i /tmp/mac_key "${MAC_VNC_USERNAME}@${MAC_HOST}"

      - name: '[2/4] Cleanup + start recording'
        if: always()
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: '[2/4] Run calculator test'
        id: test_calculator
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: ${{ secrets.MAC_HOST }}
          VNC_PORT: ${{ secrets.MAC_VNC_PORT }}
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          SCREENSHOTS_DIR: ./test-screenshots/calculator
        run: |
          echo "::add-mask::$VNC_HOST"
          node test/test.js prompts/test_calculator.md

      - name: '[2/4] Stop recording + cleanup'
        if: always()
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/calculator/recording.mp4 2>/dev/null || true
          ssh -S /tmp/mac_ssh placeholder "
            osascript -e 'quit app \"Calculator\"' 2>/dev/null
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
            osascript -e 'tell app \"System Events\" to key code 36' 2>/dev/null
          " || true

      - name: '[2/4] Reboot + wait'
        if: always()
        run: |
          ssh -S /tmp/mac_ssh -O exit placeholder 2>/dev/null || true
          ssh -i /tmp/mac_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "${MAC_VNC_USERNAME}@${MAC_HOST}" "sudo reboot" || true
          echo "Waiting for Mac to come back..."
          for i in $(seq 1 60); do
            ssh -i /tmp/mac_key -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null "${MAC_VNC_USERNAME}@${MAC_HOST}" \
              "echo ready" 2>/dev/null && break
            sleep 5
          done
          echo "Mac is ready"

      # ════════════════════════════════════════════════════════
      # TEST 3 — Scientific Calculator
      # ════════════════════════════════════════════════════════

      - name: '[3/4] SSH connect'
        if: always()
        run: |
          ssh -fN \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o LogLevel=ERROR -o ControlPath=/tmp/mac_ssh \
            -o ControlMaster=yes -o ControlPersist=yes \
            -i /tmp/mac_key "${MAC_VNC_USERNAME}@${MAC_HOST}"

      - name: '[3/4] Cleanup + start recording'
        if: always()
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: '[3/4] Run scientific calculator test'
        id: test_scientific
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: ${{ secrets.MAC_HOST }}
          VNC_PORT: ${{ secrets.MAC_VNC_PORT }}
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          SCREENSHOTS_DIR: ./test-screenshots/scientific
        run: |
          echo "::add-mask::$VNC_HOST"
          node test/test.js prompts/test_scientific_calculator.md

      - name: '[3/4] Stop recording + cleanup'
        if: always()
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/scientific/recording.mp4 2>/dev/null || true
          ssh -S /tmp/mac_ssh placeholder "
            osascript -e 'quit app \"Calculator\"' 2>/dev/null
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
            osascript -e 'tell app \"System Events\" to key code 36' 2>/dev/null
          " || true

      - name: '[3/4] Reboot + wait'
        if: always()
        run: |
          ssh -S /tmp/mac_ssh -O exit placeholder 2>/dev/null || true
          ssh -i /tmp/mac_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "${MAC_VNC_USERNAME}@${MAC_HOST}" "sudo reboot" || true
          echo "Waiting for Mac to come back..."
          for i in $(seq 1 60); do
            ssh -i /tmp/mac_key -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null "${MAC_VNC_USERNAME}@${MAC_HOST}" \
              "echo ready" 2>/dev/null && break
            sleep 5
          done
          echo "Mac is ready"

      # ════════════════════════════════════════════════════════
      # TEST 4 — Safari Browsing
      # ════════════════════════════════════════════════════════

      - name: '[4/4] SSH connect'
        if: always()
        run: |
          ssh -fN \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o LogLevel=ERROR -o ControlPath=/tmp/mac_ssh \
            -o ControlMaster=yes -o ControlPersist=yes \
            -i /tmp/mac_key "${MAC_VNC_USERNAME}@${MAC_HOST}"

      - name: '[4/4] Cleanup + start recording'
        if: always()
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: '[4/4] Run safari browsing test'
        id: test_safari
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: ${{ secrets.MAC_HOST }}
          VNC_PORT: ${{ secrets.MAC_VNC_PORT }}
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          SCREENSHOTS_DIR: ./test-screenshots/safari
        run: |
          echo "::add-mask::$VNC_HOST"
          node test/test.js prompts/test_safari_browsing.md

      - name: '[4/4] Stop recording + cleanup'
        if: always()
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/safari/recording.mp4 2>/dev/null || true
          ssh -S /tmp/mac_ssh placeholder "
            osascript -e 'quit app \"Safari\"' 2>/dev/null
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
            osascript -e 'tell app \"System Events\" to key code 36' 2>/dev/null
          " || true

      # ── Final Cleanup ─────────────────────────────────────

      - name: Close SSH
        if: always()
        run: |
          ssh -S /tmp/mac_ssh -O exit placeholder 2>/dev/null || true
          rm -f /tmp/mac_key

      - name: Upload all artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-flow
          path: test-screenshots/
          if-no-files-found: ignore

      # ── Results Summary ───────────────────────────────────

      - name: Check results
        if: always()
        run: |
          echo "═══════════════════════════════════════"
          echo " Integration Flow Results"
          echo "═══════════════════════════════════════"
          FAILED=0
          for test in integration calculator scientific safari; do
            STEP="test_${test}"
            OUTCOME="${{ steps.test_integration.outcome }}"
            [ "$test" = "calculator" ] && OUTCOME="${{ steps.test_calculator.outcome }}"
            [ "$test" = "scientific" ] && OUTCOME="${{ steps.test_scientific.outcome }}"
            [ "$test" = "safari" ] && OUTCOME="${{ steps.test_safari.outcome }}"
            if [ "$OUTCOME" = "success" ]; then
              echo " ✓ ${test}"
            else
              echo " ✗ ${test}"
              FAILED=$((FAILED + 1))
            fi
          done
          echo "═══════════════════════════════════════"
          if [ $FAILED -gt 0 ]; then
            echo "${FAILED} test(s) failed"
            exit 1
          fi
          echo "All tests passed"
