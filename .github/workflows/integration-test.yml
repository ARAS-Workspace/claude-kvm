# SPDX-License-Identifier: MIT
# Claude KVM — Integration Test
#
# Runs a real Claude session against a macOS VNC server.
# The macOS runner enables Screen Sharing, the MCP server connects to localhost,
# and Claude performs a task via the KVM tools.
#
# Artifacts: screenshots, asciinema recording, compiled video.

name: Integration Test

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Claude model to use'
        required: false
        default: 'claude-sonnet-4-5-20250929'
        type: choice
        options:
          - claude-sonnet-4-5-20250929
          - claude-opus-4-6
          - claude-haiku-4-5-20251001
      max_turns:
        description: 'Maximum agentic turns'
        required: false
        default: '30'
        type: string

env:
  TZ: Europe/Istanbul

jobs:
  integration-test:
    runs-on: macos-13
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set timezone
        run: sudo systemsetup -settimezone "Europe/Istanbul"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Install recording tools
        run: brew install asciinema ffmpeg

      - name: Enable Screen Sharing (VNC)
        run: |
          # Step 1: Configure ARD with VNC legacy password
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw testpass \
            -restart -agent -privs -all -allowAccessFor -allUsers

          # Step 2: Enable Screen Sharing launch daemon
          sudo launchctl enable system/com.apple.screensharing
          sudo launchctl bootstrap system /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true

          # Step 3: Grant TCC permissions (requires SIP disabled — macos-13 has SIP off)
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          EPOCH=$(date +%s)

          sudo sqlite3 "${TCC_DB}" "DELETE FROM access WHERE client = 'com.apple.screensharing.agent';"

          sudo sqlite3 "${TCC_DB}" \
            "INSERT INTO access (service, client, client_type, auth_value, auth_reason, auth_version, \
            indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) \
            VALUES ('kTCCServicePostEvent', 'com.apple.screensharing.agent', 0, 2, 4, 1, 0, 'UNUSED', 0, ${EPOCH});"

          sudo sqlite3 "${TCC_DB}" \
            "INSERT INTO access (service, client, client_type, auth_value, auth_reason, auth_version, \
            indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) \
            VALUES ('kTCCServiceScreenCapture', 'com.apple.screensharing.agent', 0, 2, 4, 1, 0, 'UNUSED', 0, ${EPOCH});"

          echo "TCC permissions inserted"

          # Step 4: Restart screen sharing daemon to pick up TCC changes
          sudo pkill screensharingd 2>/dev/null || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -restart -agent
          sleep 3

          # Step 5: Wait for VNC to bind
          echo "--- Waiting for VNC on port 5900 ---"
          for i in 1 2 3 4 5 6 7 8 9 10; do
            if lsof -i :5900 >/dev/null 2>&1; then
              echo "VNC listening on port 5900"
              break
            fi
            echo "  attempt $i/10..."
            sleep 2
          done

          # Diagnostics on failure
          if ! lsof -i :5900 >/dev/null 2>&1; then
            echo "--- VNC failed to start, diagnostics ---"
            csrutil status || true
            ps aux | grep -i -E 'ARD|vnc|screensharing' | grep -v grep || true
            sudo launchctl list | grep -i -E 'screen|remote' || true
            sudo sqlite3 "${TCC_DB}" "SELECT service, client, auth_value FROM access WHERE client LIKE '%screensharing%';" || true
            exit 1
          fi

      - name: Run integration test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          VNC_HOST: 127.0.0.1
          VNC_PORT: 5900
          VNC_PASSWORD: testpass
          SCREENSHOTS_DIR: ./test-screenshots
          MODEL: ${{ inputs.model || 'claude-sonnet-4-5-20250929' }}
          MAX_TURNS: ${{ inputs.max_turns || '30' }}
        run: |
          mkdir -p test-screenshots
          asciinema rec -c "node test/integration.js" test-session.cast

      - name: Compile screenshots to video
        if: always()
        run: |
          if ls test-screenshots/*.png 1>/dev/null 2>&1; then
            # Sort screenshots by name (they're zero-padded: 001-screenshot.png)
            ffmpeg -framerate 2 -pattern_type glob -i 'test-screenshots/*.png' \
              -c:v libx264 -pix_fmt yuv420p \
              -vf "pad=ceil(iw/2)*2:ceil(ih/2)*2" \
              screen-recording.mp4 || echo "⚠ Video compilation failed"
          else
            echo "No screenshots to compile"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-${{ github.run_id }}
          path: |
            screen-recording.mp4
            test-session.cast
            test-screenshots/
          retention-days: 30