# SPDX-License-Identifier: MIT
# Claude KVM — E2E Integration Test
#
# macOS runner + DigitalOcean Ubuntu droplet.
# Creates a droplet with Xvfb + XFCE + x11vnc,
# SSH tunnels VNC to localhost, runs Claude agentic test,
# then destroys the droplet.

name: Integration Test

on:
  push:
    tags:
      - 'test-v*'
  workflow_dispatch:
    inputs:
      claude_model:
        description: 'Claude orchestrator model'
        required: false
        default: 'claude-opus-4-6'
        type: choice
        options:
          - claude-opus-4-6
          - claude-sonnet-4-5-20250929
      observer_model:
        description: 'Observer model for verify() (OpenRouter)'
        required: false
        default: 'qwen/qwen3-vl-235b-a22b-instruct'
        type: string
      max_turns:
        description: 'Max Claude turns'
        required: false
        default: '25'
        type: string

env:
  TZ: Europe/Istanbul
  DO_REGION: fra1
  DO_SIZE: s-2vcpu-4gb
  DO_IMAGE: ubuntu-24-04-x64

# ─────────────────────────────────────────────────────────────

jobs:
  integration-test:
    runs-on: macos-26
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      # ── Droplet lifecycle ──────────────────────────────────

      - name: Create SSH key
        id: ssh
        run: |
          ssh-keygen -t ed25519 -f /tmp/do_key -N "" -q
          KEY_JSON=$(doctl compute ssh-key import "claude-kvm-ci-$(date +%s)" \
            --public-key-file /tmp/do_key.pub --output json)
          echo "KEY_ID=$(echo "$KEY_JSON" | jq -r '.[0].id')" >> $GITHUB_OUTPUT
          echo "KEY_FP=$(echo "$KEY_JSON" | jq -r '.[0].fingerprint')" >> $GITHUB_OUTPUT

      - name: Create droplet
        id: droplet
        run: |
          RESULT=$(doctl compute droplet create "claude-kvm-ci-$(date +%s)" \
            --image ${{ env.DO_IMAGE }} \
            --size ${{ env.DO_SIZE }} \
            --region ${{ env.DO_REGION }} \
            --ssh-keys "${{ steps.ssh.outputs.KEY_FP }}" \
            --wait --output json)
          DROPLET_ID=$(echo "$RESULT" | jq -r '.[0].id')
          DROPLET_IP=$(doctl compute droplet get "$DROPLET_ID" --output json \
            | jq -r '.[0].networks.v4[] | select(.type=="public") | .ip_address')
          echo "DROPLET_ID=$DROPLET_ID" >> $GITHUB_OUTPUT
          echo "DROPLET_IP=$DROPLET_IP" >> $GITHUB_OUTPUT
          echo "Droplet $DROPLET_ID at $DROPLET_IP"

      - name: Wait for SSH
        run: |
          for i in $(seq 1 30); do
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
              -i /tmp/do_key root@${{ steps.droplet.outputs.DROPLET_IP }} \
              "echo ready" 2>/dev/null && break
            sleep 5
          done

      # ── Desktop + VNC setup ────────────────────────────────

      - name: Wait for cloud-init and apt lock
        run: |
          ssh -o StrictHostKeyChecking=no -i /tmp/do_key \
            root@${{ steps.droplet.outputs.DROPLET_IP }} \
            "cloud-init status --wait && \
             while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do echo 'Waiting for apt lock...'; sleep 5; done"

      - name: Install desktop packages
        run: |
          ssh -o StrictHostKeyChecking=no -i /tmp/do_key \
            root@${{ steps.droplet.outputs.DROPLET_IP }} \
            "DEBIAN_FRONTEND=noninteractive apt-get update -qq && \
             apt-get install -y -qq xvfb x11vnc xfce4 xfce4-terminal thunar dbus-x11 fonts-noto-core firefox ffmpeg"

      - name: Start desktop and VNC
        run: |
          ssh -o StrictHostKeyChecking=no -i /tmp/do_key \
            root@${{ steps.droplet.outputs.DROPLET_IP }} bash -s << 'REMOTE'
          cat > /tmp/start-desktop.sh << 'EOF'
          #!/bin/sh
          export DISPLAY=:0
          Xvfb :0 -screen 0 1280x720x24 -ac &
          sleep 2
          dbus-launch startxfce4 &
          sleep 3
          x11vnc -display :0 -forever -nopw -listen 127.0.0.1 -rfbport 5900 &
          echo "Desktop ready"
          EOF
          chmod +x /tmp/start-desktop.sh
          nohup /tmp/start-desktop.sh > /tmp/desktop.log 2>&1 &
          sleep 8
          cat /tmp/desktop.log
          REMOTE

      - name: Start screen recording
        run: |
          ssh -o StrictHostKeyChecking=no -i /tmp/do_key \
            root@${{ steps.droplet.outputs.DROPLET_IP }} \
            "nohup ffmpeg -video_size 1280x720 -framerate 10 -f x11grab -i :0 \
              -c:v libx264 -preset ultrafast -pix_fmt yuv420p \
              /tmp/recording.mp4 > /tmp/ffmpeg.log 2>&1 & echo \$! > /tmp/ffmpeg.pid"
          echo "Screen recording started"

      - name: Start SSH tunnel
        run: |
          ssh -f -N -L 5900:localhost:5900 \
            -o StrictHostKeyChecking=no -i /tmp/do_key \
            root@${{ steps.droplet.outputs.DROPLET_IP }}
          sleep 2
          echo "SSH tunnel: localhost:5900 → droplet x11vnc"

      # ── Test execution ─────────────────────────────────────

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Install daemon
        run: brew install ARAS-Workspace/tap/claude-kvm-daemon

      - name: Run integration test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: 127.0.0.1
          VNC_PORT: '5900'
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          SCREENSHOTS_DIR: ./test-screenshots
          CLAUDE_MODEL: ${{ inputs.claude_model || 'claude-opus-4-6' }}
          OBSERVER_MODEL: ${{ inputs.observer_model || 'qwen/qwen3-vl-235b-a22b-instruct' }}
          MAX_TURNS: ${{ inputs.max_turns || '25' }}
        run: |
          mkdir -p test-screenshots
          node test/integration.js

      # ── Cleanup (always) ───────────────────────────────────

      - name: Stop recording and download
        if: always()
        run: |
          SSH="ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/do_key root@${{ steps.droplet.outputs.DROPLET_IP }}"
          $SSH "kill -INT \$(cat /tmp/ffmpeg.pid 2>/dev/null) 2>/dev/null; sleep 3" || true
          scp -o StrictHostKeyChecking=no -i /tmp/do_key \
            root@${{ steps.droplet.outputs.DROPLET_IP }}:/tmp/recording.mp4 \
            ./test-screenshots/recording.mp4 2>/dev/null || echo "No recording file"
          $SSH "cat /tmp/desktop.log" 2>/dev/null || echo "No remote log"

      - name: Destroy droplet
        if: always()
        run: |
          doctl compute droplet delete ${{ steps.droplet.outputs.DROPLET_ID }} --force 2>/dev/null || true
          doctl compute ssh-key delete ${{ steps.ssh.outputs.KEY_ID }} --force 2>/dev/null || true
          echo "Cleanup complete"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: test-screenshots/
          if-no-files-found: ignore
