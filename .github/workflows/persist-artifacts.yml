name: Persist Artifacts

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID'
        required: true

permissions:
  contents: write
  actions: read

jobs:
  persist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout press-kit branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: press-kit
          persist-credentials: false

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: ./downloaded
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Zip and push to press-kit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ inputs.run_id }}
        run: |
          TARGET="artifacts/${RUN_ID}"
          mkdir -p "$TARGET"

          for dir in ./downloaded/*/; do
            name=$(basename "$dir")
            (cd "$dir" && zip -r "../../${TARGET}/${name}.zip" .)
          done

          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -f "artifacts/"
          git commit -m "Persist artifacts from run ${RUN_ID}"
          git push origin press-kit
