name: Build VLM Tool

on:
  push:
    branches: [vlm-tool]
    tags: ['vlm-v*']
  pull_request:
    branches: [vlm-tool]
  workflow_dispatch:

concurrency:
  group: build-vlm-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Sign claude-kvm-vlm (macOS arm64)
    runs-on: macos-26
    timeout-minutes: 30
    env:
      TEAM_ID: 9C5SL5H7CM

    steps:
      # ── 0. Setup temp paths ─────────────────────────────────
      - name: Setup temp paths
        run: |
          echo "KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=ci_ephemeral_${{ github.run_id }}" >> "$GITHUB_ENV"
          echo "P12_PATH=$RUNNER_TEMP/certificate.p12" >> "$GITHUB_ENV"

      # ── 1. Checkout ──────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Import signing certificate ────────────────────────
      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail

          echo -n "$APPLE_CERTIFICATE_P12" | base64 --decode -o "$P12_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$P12_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

          echo "Certificate imported. Identities found:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      # ── 3. Install tools ────────────────────────────────────
      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Install Metal Toolchain
        run: xcodebuild -downloadComponent MetalToolchain

      # ── 4. Build ────────────────────────────────────────────
      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Resolve Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Claude-KVM-VLM.xcodeproj \
            -scheme claude-kvm-vlm

      - name: Build Release
        run: |
          xcodebuild \
            -project Claude-KVM-VLM.xcodeproj \
            -scheme claude-kvm-vlm \
            -configuration Release \
            ARCHS=arm64 \
            build

      # ── 5. Prepare artifact ─────────────────────────────────
      - name: Prepare artifact
        run: |
          BUILD_DIR=$(xcodebuild \
            -project Claude-KVM-VLM.xcodeproj \
            -scheme claude-kvm-vlm \
            -configuration Release \
            -showBuildSettings \
            | grep -m1 'BUILT_PRODUCTS_DIR' \
            | awk '{print $3}')

          mkdir -p artifact
          cp "$BUILD_DIR/claude-kvm-vlm" artifact/
          cp "$BUILD_DIR/mlx-swift_Cmlx.bundle/Contents/Resources/default.metallib" artifact/mlx.metallib

          echo "--- Artifact contents ---"
          ls -lh artifact/
          file artifact/claude-kvm-vlm

      # ── 6. Codesign ─────────────────────────────────────────
      - name: Codesign binary
        run: |
          codesign --sign "Developer ID Application" \
            --options runtime \
            --timestamp \
            --keychain "$KEYCHAIN_PATH" \
            artifact/claude-kvm-vlm

          echo "--- Verify signature ---"
          codesign -dvv artifact/claude-kvm-vlm

      # ── 7. Notarize ─────────────────────────────────────────
      - name: Notarize binary
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        run: |
          ditto -c -k --keepParent artifact "$RUNNER_TEMP/vlm-notarize.zip"

          xcrun notarytool submit "$RUNNER_TEMP/vlm-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait

      # ── 8. Archive & upload ─────────────────────────────────
      - name: Create archive
        run: |
          cd artifact
          tar -czf ../claude-kvm-vlm-darwin-arm64.tar.gz claude-kvm-vlm mlx.metallib

          echo "### Build Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Binary:** claude-kvm-vlm (arm64)" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Signed:** Developer ID Application" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Notarized:** Yes" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-kvm-vlm-darwin-arm64
          path: claude-kvm-vlm-darwin-arm64.tar.gz
          retention-days: 90

      # ── 9. Cleanup ──────────────────────────────────────────
      - name: Cleanup signing artifacts
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          rm -f "$P12_PATH"