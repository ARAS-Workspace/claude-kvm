name: Build Daemon Tool

on:
  workflow_call:
    inputs:
      version:
        description: "Version to build (e.g. 1.0.0)"
        required: true
        type: string
    secrets:
      DEVELOPER_ID_CERTIFICATE_P12:
        required: true
      DEVELOPER_ID_CERTIFICATE_PASSWORD:
        required: true
      APPLE_ID:
        required: true
      APPLE_ID_PASSWORD:
        required: true
  workflow_dispatch:

concurrency:
  group: build-daemon-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Sign claude-kvm-daemon (macOS arm64)
    runs-on: macos-26
    timeout-minutes: 30
    env:
      TEAM_ID: 9C5SL5H7CM

    steps:
      # ── 0. Setup temp paths ─────────────────────────────────
      - name: Setup temp paths
        run: |
          echo "KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=ci_ephemeral_${{ github.run_id }}" >> "$GITHUB_ENV"
          echo "P12_PATH=$RUNNER_TEMP/certificate.p12" >> "$GITHUB_ENV"

      # ── 1. Checkout ──────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Import signing certificate ────────────────────────
      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail

          echo -n "$APPLE_CERTIFICATE_P12" | base64 --decode -o "$P12_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$P12_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

          echo "Certificate imported. Identities found:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      # ── 3. Install tools ────────────────────────────────────
      - name: Install build dependencies
        run: brew install xcodegen openssl@3

      - name: Install Metal Toolchain
        run: xcodebuild -downloadComponent MetalToolchain

      # ── 4. Build ────────────────────────────────────────────
      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Resolve Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Claude-KVM-Daemon.xcodeproj \
            -scheme claude-kvm-daemon

      - name: Build Release
        run: |
          xcodebuild \
            -project Claude-KVM-Daemon.xcodeproj \
            -scheme claude-kvm-daemon \
            -configuration Release \
            ARCHS=arm64 \
            build

      # ── 5. Prepare artifact ─────────────────────────────────
      - name: Prepare artifact
        run: |
          BUILD_DIR=$(xcodebuild \
            -project Claude-KVM-Daemon.xcodeproj \
            -scheme claude-kvm-daemon \
            -configuration Release \
            -showBuildSettings \
            | grep -m1 'BUILT_PRODUCTS_DIR' \
            | awk '{print $3}')

          mkdir -p artifact
          cp "$BUILD_DIR/claude-kvm-daemon" artifact/
          cp "$BUILD_DIR/mlx-swift_Cmlx.bundle/Contents/Resources/default.metallib" artifact/mlx.metallib

          echo "--- Artifact contents ---"
          ls -lh artifact/
          file artifact/claude-kvm-daemon

      # ── 6. Codesign ─────────────────────────────────────────
      - name: Codesign binary
        run: |
          codesign --force \
            --sign "Developer ID Application" \
            --options runtime \
            --entitlements entitlements.plist \
            --timestamp \
            --keychain "$KEYCHAIN_PATH" \
            artifact/claude-kvm-daemon

          echo "--- Verify signature ---"
          codesign -dvv artifact/claude-kvm-daemon

      # ── 7. Create tar.gz (signed binary, for Homebrew) ─────
      - name: Create tar.gz
        run: |
          VERSION="${{ inputs.version || '0.0.0' }}"
          TAR_NAME="claude-kvm-daemon-${VERSION}-darwin-arm64.tar.gz"

          tar -czf "$TAR_NAME" -C artifact .

          echo "TAR_NAME=$TAR_NAME" >> "$GITHUB_ENV"
          echo "--- tar.gz created ---"
          ls -lh "$TAR_NAME"

      # ── 8. Create DMG ──────────────────────────────────────
      - name: Create DMG
        run: |
          VERSION="${{ inputs.version || '0.0.0' }}"
          DMG_NAME="claude-kvm-daemon-${VERSION}-darwin-arm64.dmg"

          hdiutil create \
            -volname "claude-kvm-daemon" \
            -srcfolder artifact \
            -ov -format UDZO \
            "$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"
          echo "--- DMG created ---"
          ls -lh "$DMG_NAME"

      # ── 9. Notarize & staple DMG ───────────────────────────
      - name: Notarize & staple DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        run: |
          xcrun notarytool submit "$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait

          xcrun stapler staple "$DMG_NAME"

          echo "--- Verify staple ---"
          xcrun stapler validate "$DMG_NAME"

          echo "### Build Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Binary:** claude-kvm-daemon (arm64)" >> "$GITHUB_STEP_SUMMARY"
          echo "- **DMG:** $DMG_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **tar.gz:** $TAR_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Signed:** Developer ID Application" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Notarized:** Yes (DMG stapled)" >> "$GITHUB_STEP_SUMMARY"

      # ── 10. Upload artifacts ────────────────────────────────
      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DMG_NAME }}
          path: ${{ env.DMG_NAME }}
          retention-days: 90

      - name: Upload tar.gz
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: ${{ env.TAR_NAME }}
          retention-days: 90

      # ── 11. Cleanup ─────────────────────────────────────────
      - name: Cleanup signing artifacts
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          rm -f "$P12_PATH"
