# SPDX-License-Identifier: MIT
# Claude KVM — Mac Phantom-WG Install Test (Scaleway Apple Silicon)
#
# Manual trigger — pre-provisioned Scaleway Mac mini M1.
# Test code lives on test/e2e/mac branch.
# Experimental: 100-turn complex installation scenario.

name: Mac Phantom-WG Install Test

on:
  workflow_dispatch:
    inputs:
      executor_model:
        description: 'Executor model'
        default: 'claude-opus-4-6'
      observer_model:
        description: 'Observer model'
        default: 'qwen/qwen3-vl-235b-a22b-instruct'
      max_turns:
        description: 'Max executor turns'
        default: '100'

# ─────────────────────────────────────────────────────────────

jobs:
  install-phantom-test:
    runs-on: macos-26
    timeout-minutes: 60

    env:
      TZ: Europe/Istanbul

    steps:
      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          ref: test/e2e/mac

      # ── SSH Setup ──────────────────────────────────────────

      - name: Setup SSH
        env:
          MAC_SSH_PRIVATE_KEY: ${{ secrets.MAC_SSH_PRIVATE_KEY }}
          MAC_HOST: ${{ secrets.MAC_HOST }}
          MAC_VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
        run: |
          echo "::add-mask::$MAC_HOST"

          mkdir -p ~/.ssh
          printf '%s\n' "$MAC_SSH_PRIVATE_KEY" > /tmp/mac_key
          chmod 600 /tmp/mac_key

          ssh -fN \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o LogLevel=ERROR \
            -o ControlPath=/tmp/mac_ssh \
            -o ControlMaster=yes \
            -o ControlPersist=yes \
            -i /tmp/mac_key \
            "${MAC_VNC_USERNAME}@${MAC_HOST}"

          echo "SSH ready"

      # ── Screen Recording ───────────────────────────────────

      - name: Cleanup remote recordings
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true

      - name: Start screen recording
        run: python3 scripts/record.py start

      # ── Test Execution ─────────────────────────────────────

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Install daemon
        run: brew install ARAS-Workspace/tap/claude-kvm-daemon

      - name: Run Phantom-WG install test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: ${{ secrets.MAC_HOST }}
          VNC_PORT: ${{ secrets.MAC_VNC_PORT }}
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          SCREENSHOTS_DIR: ./test-screenshots
          EXECUTOR_MODEL: ${{ inputs.executor_model }}
          OBSERVER_MODEL: ${{ inputs.observer_model }}
          EXECUTOR_MAX_TURNS: ${{ inputs.max_turns }}
        run: |
          echo "::add-mask::$VNC_HOST"
          mkdir -p test-screenshots
          node test/test.js prompts/test_install_phantom_app.md

      # ── Cleanup (always) ───────────────────────────────────

      - name: Stop recording and download
        if: always()
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/recording.mp4 2>/dev/null || \
          echo "No recording file"

      - name: Reset remote desktop
        if: always()
        run: |
          ssh -S /tmp/mac_ssh placeholder "
            osascript -e 'quit app \"Safari\"' 2>/dev/null
            osascript -e 'quit app \"Phantom-WG\"' 2>/dev/null
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
            osascript -e 'tell app \"System Events\" to key code 36' 2>/dev/null
          " || true

      - name: Close SSH
        if: always()
        run: |
          ssh -S /tmp/mac_ssh -O exit placeholder 2>/dev/null || true
          rm -f /tmp/mac_key

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-install-phantom
          path: test-screenshots/
          if-no-files-found: ignore