# SPDX-License-Identifier: MIT
# Claude KVM — Mac Phantom-WG Install Test (Scaleway Apple Silicon)
#
# Manual trigger — pre-provisioned Scaleway Mac mini M1.
# Test code lives on test/e2e/mac branch.
# 4-phase installation: Download → Install → Launch → Verify
# VNC via SSH tunnel to avoid brute-force auth degradation.

name: Mac Phantom-WG Install Test

on:
  workflow_dispatch:
    inputs:
      executor_model:
        description: 'Executor model'
        default: 'claude-opus-4-6'
      observer_model:
        description: 'Observer model'
        default: 'qwen/qwen3-vl-235b-a22b-instruct'
      max_turns:
        description: 'Max executor turns per phase'
        default: '30'

# ─────────────────────────────────────────────────────────────

jobs:
  install-phantom-test:
    runs-on: macos-26
    timeout-minutes: 60

    env:
      TZ: Europe/Istanbul
      PROMPT_FILE: test/prompts/test_install_phantom_app.md

    steps:
      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          ref: test/e2e/mac

      # ── Common Setup ─────────────────────────────────────────

      - name: Write SSH key
        env:
          MAC_SSH_PRIVATE_KEY: ${{ secrets.MAC_SSH_PRIVATE_KEY }}
        run: |
          echo "::add-mask::${{ secrets.MAC_HOST }}"
          mkdir -p ~/.ssh
          printf '%s\n' "$MAC_SSH_PRIVATE_KEY" > /tmp/mac_key
          chmod 600 /tmp/mac_key

      - name: SSH connect + VNC tunnel
        env:
          MAC_HOST: ${{ secrets.MAC_HOST }}
          MAC_VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
        run: |
          ssh -fN \
            -L 5901:localhost:5900 \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o LogLevel=ERROR -o ControlPath=/tmp/mac_ssh \
            -o ControlMaster=yes -o ControlPersist=yes \
            -i /tmp/mac_key "${MAC_VNC_USERNAME}@${MAC_HOST}"
          ssh -S /tmp/mac_ssh placeholder "nohup caffeinate -d -i -s >/dev/null 2>&1 &"
          echo "SSH + VNC tunnel ready (localhost:5901)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Install daemon
        run: brew install ARAS-Workspace/tap/claude-kvm-daemon

      # ════════════════════════════════════════════════════════════
      # Phase 1: Download
      # ════════════════════════════════════════════════════════════

      - name: "[1/4] Cleanup & start recording"
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: "[1/4] Run Download phase"
        continue-on-error: true
        id: phase1
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: localhost
          VNC_PORT: '5901'
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          CLAUDE_KVM_DAEMON_PARAMETERS: "-v"
          SCREENSHOTS_DIR: ./test-screenshots/phase-1
          EXECUTOR_MODEL: ${{ inputs.executor_model }}
          OBSERVER_MODEL: ${{ inputs.observer_model }}
          EXECUTOR_MAX_TURNS: ${{ inputs.max_turns }}
        run: |
          mkdir -p test-screenshots/phase-1
          awk '/^# Download$/{f=1;next} /^# [A-Z]/{if(f)exit} f' "$PROMPT_FILE" > /tmp/phase-prompt.md
          cat /tmp/phase-prompt.md
          node test/test.js /tmp/phase-prompt.md

      - name: "[1/4] Stop recording & download"
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/phase-1/recording.mp4 2>/dev/null || echo "No recording"

      - name: "[1/4] Reset desktop"
        run: |
          ssh -S /tmp/mac_ssh placeholder "
            osascript -e 'quit app \"Safari\"' 2>/dev/null
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
          " || true

      # ════════════════════════════════════════════════════════════
      # Phase 2: Install
      # ════════════════════════════════════════════════════════════

      - name: "[2/4] Cleanup & start recording"
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: "[2/4] Run Install phase"
        continue-on-error: true
        id: phase2
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: localhost
          VNC_PORT: '5901'
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          CLAUDE_KVM_DAEMON_PARAMETERS: "-v"
          SCREENSHOTS_DIR: ./test-screenshots/phase-2
          EXECUTOR_MODEL: ${{ inputs.executor_model }}
          OBSERVER_MODEL: ${{ inputs.observer_model }}
          EXECUTOR_MAX_TURNS: ${{ inputs.max_turns }}
        run: |
          mkdir -p test-screenshots/phase-2
          awk '/^# Install$/{f=1;next} /^# [A-Z]/{if(f)exit} f' "$PROMPT_FILE" > /tmp/phase-prompt.md
          cat /tmp/phase-prompt.md
          node test/test.js /tmp/phase-prompt.md

      - name: "[2/4] Stop recording & download"
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/phase-2/recording.mp4 2>/dev/null || echo "No recording"

      - name: "[2/4] Reset desktop"
        run: |
          ssh -S /tmp/mac_ssh placeholder "
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
          " || true

      # ════════════════════════════════════════════════════════════
      # Phase 3: Launch
      # ════════════════════════════════════════════════════════════

      - name: "[3/4] Write temp password for system extension approval"
        env:
          MAC_VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
        run: |
          ssh -S /tmp/mac_ssh placeholder "echo '${MAC_VNC_PASSWORD}' > /tmp/.test_pass && chmod 600 /tmp/.test_pass"

      - name: "[3/4] Cleanup & start recording"
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: "[3/4] Run Launch phase"
        continue-on-error: true
        id: phase3
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: localhost
          VNC_PORT: '5901'
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          CLAUDE_KVM_DAEMON_PARAMETERS: "-v"
          SCREENSHOTS_DIR: ./test-screenshots/phase-3
          EXECUTOR_MODEL: ${{ inputs.executor_model }}
          OBSERVER_MODEL: ${{ inputs.observer_model }}
          EXECUTOR_MAX_TURNS: ${{ inputs.max_turns }}
        run: |
          mkdir -p test-screenshots/phase-3
          awk '/^# Launch$/{f=1;next} /^# [A-Z]/{if(f)exit} f' "$PROMPT_FILE" > /tmp/phase-prompt.md
          cat /tmp/phase-prompt.md
          node test/test.js /tmp/phase-prompt.md

      - name: "[3/4] Stop recording & download"
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/phase-3/recording.mp4 2>/dev/null || echo "No recording"

      - name: "[3/4] Clean temp password & reset desktop"
        run: |
          ssh -S /tmp/mac_ssh placeholder "
            rm -f /tmp/.test_pass
            osascript -e 'quit app \"Phantom-WG\"' 2>/dev/null
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
          " || true

      # ════════════════════════════════════════════════════════════
      # Phase 4: Verify
      # ════════════════════════════════════════════════════════════

      - name: "[4/4] Cleanup & start recording"
        run: |
          ssh -S /tmp/mac_ssh placeholder \
            "kill \$(pgrep -f avfoundation) 2>/dev/null; rm -f /tmp/recording.mp4" || true
          python3 scripts/record.py start

      - name: "[4/4] Run Verify phase"
        continue-on-error: true
        id: phase4
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VNC_HOST: localhost
          VNC_PORT: '5901'
          VNC_USERNAME: ${{ secrets.MAC_VNC_USERNAME }}
          VNC_PASSWORD: ${{ secrets.MAC_VNC_PASSWORD }}
          CLAUDE_KVM_DAEMON_PATH: claude-kvm-daemon
          CLAUDE_KVM_DAEMON_PARAMETERS: "-v"
          SCREENSHOTS_DIR: ./test-screenshots/phase-4
          EXECUTOR_MODEL: ${{ inputs.executor_model }}
          OBSERVER_MODEL: ${{ inputs.observer_model }}
          EXECUTOR_MAX_TURNS: ${{ inputs.max_turns }}
        run: |
          mkdir -p test-screenshots/phase-4
          awk '/^# Verify$/{f=1;next} f' "$PROMPT_FILE" > /tmp/phase-prompt.md
          cat /tmp/phase-prompt.md
          node test/test.js /tmp/phase-prompt.md

      - name: "[4/4] Stop recording & download"
        run: |
          python3 scripts/record.py stop || true
          scp -o ControlPath=/tmp/mac_ssh \
            placeholder:/tmp/recording.mp4 \
            ./test-screenshots/phase-4/recording.mp4 2>/dev/null || echo "No recording"

      # ── Final Cleanup ─────────────────────────────────────────

      - name: Reset remote desktop
        if: always()
        run: |
          ssh -S /tmp/mac_ssh placeholder "
            rm -f /tmp/.test_pass
            osascript -e 'quit app \"Safari\"' 2>/dev/null
            osascript -e 'quit app \"Phantom-WG\"' 2>/dev/null
            osascript -e 'tell app \"Finder\" to close every window' 2>/dev/null
          " || true

      - name: Close SSH
        if: always()
        run: |
          ssh -S /tmp/mac_ssh -O exit placeholder 2>/dev/null || true
          rm -f /tmp/mac_key

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-install-phantom
          path: test-screenshots/
          if-no-files-found: ignore